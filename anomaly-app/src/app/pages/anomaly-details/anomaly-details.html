<div class="popup-overlay" *ngIf="isVisible" (click)="onClose()">
  <div class="popup-content" (click)="$event.stopPropagation()">
    <div class="popup-header">
      <h2>Anomaly Details</h2>
      <button class="close-button" (click)="onClose()">√ó</button>
    </div>
    
    <div class="popup-body" *ngIf="anomalyData">
      <div class="detail-section news-section" *ngIf="newsData || isLoadingNews">
        <h3>üì∞ News Information</h3>
        
        <div class="loading-news" *ngIf="isLoadingNews">
          <div class="loading-spinner"></div>
          <span>Loading news data...</span>
        </div>
        
        <div class="news-content" *ngIf="newsData && !isLoadingNews">
          <div class="news-error" *ngIf="newsData.error">
            <span class="error-message">‚ùå {{ newsData.error }}</span>
          </div>
          
          <div class="news-summary" *ngIf="newsData && !newsData.error && newsData.output">
          
            <!-- Market Sentiment -->
            <div class="sentiment-card">
              <div class="sentiment-header">
                <span class="sentiment-label">Market Sentiment</span>
                <span class="sentiment-value" [ngClass]="'sentiment-' + newsData.output?.MarketSentiment?.toLowerCase()">
                  {{ newsData.output?.MarketSentiment }}
                </span>
              </div>
            </div>

            <!-- Impact Score -->
            <div class="impact-card">
              <div class="impact-header">
                <span class="impact-label">Overall Impact Score</span>
                <span class="impact-value">{{ newsData.output?.DebugData?.overallAverageImpact }}%</span>
              </div>
            </div>

            <!-- Articles Count -->
            <div class="articles-card">
              <div class="articles-header">
                <span class="articles-label">Total Articles Analyzed</span>
                <span class="articles-value">{{ newsData.output?.DebugData?.totalArticles }}</span>
              </div>
            </div>

            <!-- News Summary -->
            <div class="summary-card">
              <div class="summary-title">üì∞ News Summary</div>
              <div class="summary-text">{{ newsData.output?.NewsSummary }}</div>
            </div>

            <!-- Detailed Analysis -->
            <div class="analysis-card" *ngIf="newsData.output?.DebugData?.newsSummary">
              <div class="analysis-header" (click)="toggleAnalysis()">
                <div class="analysis-title">üîç Detailed Market Analysis</div>
                <span class="expand-arrow" [class.expanded]="isAnalysisExpanded">‚ñ∂</span>
              </div>
              <div class="analysis-content" [class.expanded]="isAnalysisExpanded" [class.collapsed]="!isAnalysisExpanded">
                <div class="analysis-text">{{ newsData.output?.DebugData?.newsSummary }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="detail-section" *ngIf="analyzedPeriod">
        <h3>Analyzed Period</h3>
        <div class="detail-row">
          <span class="label">From:</span>
          <span class="value">{{ analyzedPeriod.startDate }}</span>
        </div>
        <div class="detail-row">
          <span class="label">To:</span>
          <span class="value">{{ analyzedPeriod.endDate }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Duration:</span>
          <span class="value">{{ analyzedPeriod.duration }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Total Data Points:</span>
          <span class="value">{{ analyzedPeriod.totalPoints | number }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Anomaly Points:</span>
          <span class="value anomaly-count">{{ analyzedPeriod.anomalyPoints | number }}</span>
        </div>
      </div>

      <div class="detail-section">
        <h3>Basic Information</h3>
        <div class="detail-row">
          <span class="label">Date:</span>
          <span class="value">{{ anomalyData.date_of_use }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Feature:</span>
          <span class="value">{{ anomalyData.Feature }}</span>
        </div>
        <div class="detail-row">
          <span class="label">User Count:</span>
          <span class="value">{{ anomalyData.distinct_CID_count | number }}</span>
        </div>
      </div>

      <div class="detail-section">
        <h3>Anomaly Analysis</h3>
        <div class="detail-row">
          <span class="label">Z-Score:</span>
          <span class="value">{{ anomalyData.z_score }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Severity:</span>
          <span class="value severity" [ngClass]="'severity-' + anomalyData.anomaly_severity.toLowerCase()">
            {{ anomalyData.anomaly_severity }}
          </span>
        </div>
        <div class="detail-row">
          <span class="label">Is Anomaly:</span>
          <span class="value" [ngClass]="anomalyData.is_anomaly === 'True' ? 'anomaly-true' : 'anomaly-false'">
            {{ anomalyData.is_anomaly }}
          </span>
        </div>
        <div class="detail-row">
          <span class="label">Anomaly Score:</span>
          <span class="value">{{ anomalyData.anomaly_score }}</span>
        </div>
      </div>

      <div class="detail-section">
        <h3>Additional Details</h3>
        <div class="detail-row">
          <span class="label">Week Start:</span>
          <span class="value">{{ anomalyData.week_start }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Month:</span>
          <span class="value">{{ anomalyData.month }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Quarter:</span>
          <span class="value">{{ anomalyData.quarter }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Is Weekend:</span>
          <span class="value">{{ anomalyData.is_weekend }}</span>
        </div>
      </div>
    </div>
  </div>
</div>
